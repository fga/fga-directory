<!DOCTYPE html>
<html>

  <head>
    <meta charset=utf-8 />
    <title>#Occupy Directory World Map</title>
	<link href='http://fonts.googleapis.com/css?family=Dosis:500,300&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="css/map.css" type="text/css" />
  </head>
	
<body>
  	
	<div id="map" class="map"></div>

	<div id="sideBar"></div>	
<!--
	<div id="header">
		
		<h1 id="directory_title"><a href='http://directory.occupy.net' target='_blank'>#Occupy Directory</a></h1>

		<div data-control='geocode' id="search">
			<form class="geocode">
				<input placeholder='Search for City' size="49" type="text">
				<input id="searchButton" type="image" src="img/search.png" />
				<div id='geocode-error'></div>
			</form>
		</div>
	
	</div>
-->
    
  <!-- External libraries and site script -->
  <script src="js/ext/jquery.min.js"></script>
  <script src="js/ext/modestmaps.js"></script>
  <script src="js/ext/wax/wax.mm.js"></script>
  <script src="js/ext/markers.js"></script>

  <!-- Site configuration -->
  <script type="text/javascript">

		/*
			Function: buildConsoleObject
			Quick hack to prevent browsers w/o a console, or firebug from generating errors when console functions are called. Gets called immediately
		*/
		if (!window.console ){
  	  var names = ["log", "debug", "info", "warn", "error", "assert", "dir", "dirxml", "group", "groupEnd", "time", "timeEnd", "count", "trace", "profile", "profileEnd"];
  	  window.console = {};
  	  for (var i = 0; i < names.length; ++i){ window.console[names[i]] = function() {}; }
			names = null;
		}

		directory = {

			map: {

				api: 'http://a.tiles.mapbox.com/v3/occupydirectory.map-ftbke77j.jsonp',

				center: {
					lat: 19,
					lon: 9.7,
					zoom: 2
				},

				options: {
					toolContainer: null,
					legend: true,
					moveTips: true,
					share: true,
					bwDetect: true,
					toolTips: true,
					zoomBox: true,
					zoomPan: true,
					zoomWheel: false,
					hash: true
				},

				zoomRange: {
					min: 2,
					max: 11
				}

			}

		};
		
		directory.initMap = function( el ){

			directory.map.container = el;


//			console.log( 'directory.map.container', directory.map.container );

			directory.map.instance = wax.tilejson(
		
				directory.map.api,

				function( tiles ) {
			
					console.log( "tiles", tiles );
					console.log( 'container', directory.map.container, el );
//					console.log( 'arguments', arguments );

		            var handlers = [
		                new MM.DragHandler(),
//		                new MM.DoubleClickHandler(),
		             		new MM.TouchHandler()
					];
	            
					if ( directory.map.options.zoomWheel ) handlers.push( new MM.MouseWheelHandler() );
	            
					directory.modestMap = new MM.Map( directory.map.container, new wax.mm.connector( tiles ), null, handlers);

	 				var modestMap = directory.modestMap;
 				
	 				if( directory.map.center ){
	 					var c = directory.map.center;
	 			        modestMap.setCenterZoom({
			                lat: ( c.lat ) ? c.lat : tiles.center[1],
			                lon: ( c.lon) ? c.lon : tiles.center[0]
			            }, ( c.zoom ) ? c.zoom : c.center[2]);
	 				}
 				
					if( directory.map.zoomRange ){
						console.log( 'has zoomRange' );
						var z = directory.map.zoomRange;
						modestMap.setZoomRange( z.min, z.max );
					} else {
						modestMap.setZoomRange( tiles.minzoom, tiles.maxzoom);
					}

					var toolContainer = ( directory.map.options.toolContainer )? directory.map.options.toolContainer : directory.map.container;
    	        
					if( directory.map.options.attribution ){
						console.log( 'hasAttribution' );
						wax.mm.attribution( modestMap, tiles ).appendTo( toolContainer );
					}
				
					if( directory.map.options.zoomPan ){
						console.log( 'hasZoomPan' );
						wax.mm.zoomer( modestMap ).appendTo( toolContainer );					
					}

					if( directory.map.options.zoomBox ){
						console.log( 'hasZoomBox');
						wax.mm.zoombox( modestMap );					
					}

					if( directory.map.options.legend ){
						console.log( "hasLegend" );
						modestMap.legend = wax.mm.legend( modestMap, tiles ).appendTo( toolContainer );				
					}
				
					if( directory.map.options.bwDetect ){
						wax.mm.bwdetect(modestMap);
					}

					if( directory.map.options.share ){
//						wax.mm.share( modestMap, tiles ).appendTo( toolContainer );
					}

					console.log( directory.map.options.toolTips );
					
					if( directory.map.options.toolTips ){
						console.log("hasTooltips");
						modestMap.toolTipInteraction = wax.mm.interaction().map(modestMap).tilejson( tiles ).on( wax.tooltip().animate( true ).parent( toolContainer ).events() );
/*						modestMap.toolTipInteraction.on({
							on: function( obj ) {
								if( obj.e.type == 'click' ){
//									obj.e.preventDefault();
									obj.data.__full__ = true;
									var sidebarContent = Mustache.to_html( tiles.template , obj.data );
									$('#sideBar').html( sidebarContent );
								}
							}
						});
*/				}

					if( directory.map.options.moveTips ){
						console.log("hasMoveTips");
						modestMap.moveTipInteraction = wax.mm.interaction()
							.map( modestMap )
							.tilejson( tiles )
							.on(wax.movetip()
							.parent( toolContainer )
							.events()
						)
						modestMap.moveTipInteraction.on({
							on: function( obj ) {
								if( obj.e.type == 'click' ){
//									obj.e.preventDefault();
									obj.data.__full__ = true;
									var sidebarContent = Mustache.to_html( tiles.template , obj.data );
									$('#sideBar').html( sidebarContent );
									console.log('hello', sidebarContent );
								}
							}
						});
					}
						
					if( directory.map.options.hash ){
						console.log('hasHash');
						wax.mm.hash( modestMap, tiles, {
							defaultCenter: new MM.Location(39, -98),
  						defaultZoom: 4,
  						manager: wax.mm.pushState
						});
					}
				
				}); // end tilejson call
		}
		
		$( function(){
			directory.initMap( $('#map')[0] );
		});

  </script>

</body>
</html>
